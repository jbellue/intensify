<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8"> 
		<script type="text/javascript" src="./js/LZWEncoder.js"></script>
		<script type="text/javascript" src="./js/NeuQuant.js"></script>
		<script type="text/javascript" src="./js/GIFEncoder.js"></script>
		<script type="text/javascript" src="./js/b64.js"></script>
		<script type="text/javascript" src="./js/load-image.all.min.js"></script>
	</head>
	<body>
		<div id="error" style="display: none">File not found</div>
		<input type="text" id="text" value="[INTENSITY INTENSIFIES]"><br>
		<input type="text" id="url-input">
		<button type="button" onclick="select_url()">Intensify</button><br>
		<input type="file" id="file-input" value="file" accept=".jpg, .jpeg, .png" onchange="select_file(this)">
		<br>
		<canvas id="bitmap"><canvas/>

<script>
function select_file(input) {
	if (input.files && input.files[0]) {
		intensify(input.files[0])
	}
}

function select_url() {
	console.log("select urlk");
	var URL = document.getElementById("url-input").value;
	intensify(URL);
}

function intensify(img) {
	console.log("intensify");
    loadImage(
        img,
        function (img) {
			if(img.type === "error") {
				console.log("Unable to load file");
				document.getElementById("error").display = "block";
			} else {
				create_gif(img);
			}
        },
        {
			crossOrigin: true
		}
    );
};
function create_gif(source_file) {
	console.log("create gif");
	// Set up the canvas.
	let canvas = document.getElementById("bitmap");
	let ctx = canvas.getContext("2d");
	canvas.width = source_file.width - 15;
	canvas.height = source_file.height - 15;

	let encoder = new GIFEncoder();
	encoder.setRepeat(0);
	encoder.setDelay(40);
	encoder.start();

	ctx.font = '20pt Impact';
	ctx.fillStyle = 'White';
	ctx.lineWidth = 1;
	ctx.strokeStyle = 'Black';
	ctx.textAlign = 'center';
	let text = document.getElementById("text").value;

	for (let i=0; i < 5; i++){
		draw_gif_frame(ctx, source_file, text, i);
		console.log(encoder.addFrame(ctx), i);
		ctx.clearRect(0, 0, canvas.width, canvas.height);
	}

	encoder.finish();
	let data_url = 'data:image/gif;base64,'+encode64(encoder.stream().getData());

	let intense_gif = document.getElementById("intensity_image");
	if (intense_gif == undefined) {
		intense_gif = new Image();
		intense_gif.id = "intensity_image";
		intense_gif.src = data_url;
		document.body.appendChild(intense_gif);
	}
	else {
		intense_gif.src = data_url;
	}
	intense_gif.width = canvas.width;
	intense_gif.height = canvas.height;
	canvas.width = 0;
	canvas.height = 0;
}

function draw_gif_frame(ctx, img, text, frame) {
	console.log("frame ", frame)
	switch (frame){
		case 0:
			image_x = -15;
			image_y = -15;
			break;
		case 1:
			image_x = -7;
			image_y = 0;
			break;
		case 2:
			image_x = 0;
			image_y = -7;
			break;
		case 3:
			image_x = 0;
			image_y = -15;
			break;
		default:
			image_x = -7;
			image_y = 0;
			break;
	}
	
	ctx.drawImage(img, image_x, image_y);
	text_x = (img.width - 15) / 2;
	text_y = (img.height - 15) * 0.9
	ctx.fillText(text, text_x, text_y);
	ctx.strokeText(text, text_x, text_y);
	ctx.fill();
	ctx.stroke();
}
</script>
	</body>
</html>
